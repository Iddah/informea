<?php
/**
 * @file
 * Code for the country_data feature.
 */

include_once 'country_data.features.inc';

/**
 * Defines menu items and page callbacks.
 *
 * @return
 *   An associative array of properties for each path.
 */
function country_data_menu() {
  $items['countries'] = array(
    'title' => 'Countries',
    'page callback' => 'country_data_map_view',
    'access arguments' => array('access content')
  );

  $items['countries/list'] = array(
    'title' => 'Countries',
    'page callback' => 'country_data_list_view',
    'access arguments' => array('access content')
  );

  return $items;
}

/**
 * Loads the properties of areas.
 *
 * @return
 *   An associative array of properties for each area.
 */
function _country_data_get_areas() {
  // Loads the enabled countries.
  $countries = countries_get_countries('all', array('enabled' => COUNTRIES_ENABLED));

  foreach ($countries as $iso2 => $country) {
    $areas[] = array('id' => $iso2);
  }

  return $areas;
}

/**
 * Displays the countries map page when the user visits the path.
 *
 * @return
 *   String representing the content of the page.
 */
function country_data_map_view() {
  // Adds the amCharts JavaScript files to the page.
  drupal_add_js('http://www.amcharts.com/lib/3/ammap.js', 'external');
  drupal_add_js('http://www.amcharts.com/lib/3/maps/js/worldHigh.js', 'external');
  drupal_add_js('http://www.amcharts.com/lib/3/themes/light.js', 'external');

  // Adds the properties of areas to Drupal's global storage of JavaScript
  // settings.
  drupal_add_js(array('areas' => _country_data_get_areas()), 'setting');

  // Adds the countries map JavaScript file to the page.
  drupal_add_js(drupal_get_path('module', 'country_data') . '/js/countries-map.js');

  return theme('countries_map');
}

/**
 * Registers module's theme implementations.
 *
 * @return
 *   An associative array of theme hook information.
 */
function country_data_theme() {
  return array(
    'countries_map' => array()
  );
}
