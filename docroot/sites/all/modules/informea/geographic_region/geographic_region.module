<?php
/**
 * @file
 * Code for the Geographic region feature.
 */

include_once 'geographic_region.features.inc';

function geographic_region_block_info() {
  return [
    'region_switch_topic' => [
      'info' => t('Browse by Environmental Topic'),
      'cache' => DRUPAL_CACHE_PER_PAGE,
    ],
  ];
}

/**
 * Implements hook_block_view().
 */
function geographic_region_block_view($delta = '') {
  $block = array();
  switch($delta) {
    case 'region_switch_topic':
      $page = page_manager_get_current_page();
      $vocabulary = taxonomy_vocabulary_machine_name_load('mea_topic');
      $terms = entity_load('taxonomy_term', FALSE, ['vid' => $vocabulary->vid]);
      usort($terms, function($a, $b) {
        return strcmp($a->name, $b->name);
      });

      $current_topic = !empty($page['contexts']['argument_term_2']->argument)
        ? $page['contexts']['argument_term_2']->argument
        : NULL;

      $region_path = 'regions/' . $page['contexts']['argument_term_1']->original_argument;
      $tabs = [
        [
          'data' => l(t('All topics'), $region_path),
          'class' => empty($current_topic) ? ['active'] : [],
        ]
      ];
      foreach ($terms as $term) {
        $tabs[] = [
          'data' => l($term->name, $region_path . '/' . $term->name),
          'class' => !empty($current_topic) && $current_topic == $term->tid ? ['active'] : [],
        ];
      }
      $block['content'] = [
        '#theme' => 'item_list',
        '#items' => $tabs,
        '#attributes' => ['class' => ['nav nav-tabs']]
      ];
  }
  return $block;
}
