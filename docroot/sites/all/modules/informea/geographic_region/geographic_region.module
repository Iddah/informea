<?php
/**
 * @file
 * Code for the Geographic region feature.
 */

include_once 'geographic_region.features.inc';
include_once 'blocks/region_downloadable_documents.block.inc';
include_once 'blocks/region_page_title.block.inc';
include_once 'blocks/region_switch_topic.block.inc';

/**
 * Implements hook_block_info().
 */
function geographic_region_block_info() {
  return [
    'region_page_title' => [
      'info' => t('Page title for regional page'),
      'status' => 1,
      'region' => 'navigation',
      'weight' => -56,
      'visibility' => BLOCK_VISIBILITY_LISTED,
      'pages' => 'regions/*',
      'cache' => DRUPAL_CACHE_PER_PAGE,
    ],
    'region_switch_topic' => [
      'info' => t('Browse by Environmental Topic'),
      'cache' => DRUPAL_CACHE_PER_PAGE,
    ],
    'region_downloadable_documents' => [
      'info' => t('Downloadable documents'),
      'cache' => DRUPAL_CACHE_PER_PAGE,
    ],
  ];
}

/**
 * Retrieve treaties node ids filtered by region and (optional) by topic.
 *
 * @param int $region_id
 *  Region term tid.
 * @param null|int $topic_id
 *  Topic term tid.
 *
 * @return array
 *  Array containing node ids.
 */
function _get_regional_treaties($region_id, $topic_id = NULL) {
  $treaties = [];
  /** @var \view $view */
  $view = views_get_view('regional_treaties');
  if (is_object($view)) {
    $view->set_arguments([$region_id, $topic_id]);
    $view->set_display('block');
    $view->set_items_per_page(0);
    $view->pre_execute();
    $view->execute();
    foreach ($view->result as $result) {
      $treaties[] = $result->nid;
    }
  }
  return $treaties;
}

/**
 * Retrieves the region id contextual filter if available.
 *
 * @return null|int
 *  Region term tid.
 */
function _geographic_region_page_get_region_argument() {
  $page = page_manager_get_current_page();
  if (!empty($page['contexts']['argument_term_1']->argument)) {
    return $page['contexts']['argument_term_1']->argument;
  }
  return NULL;
}

/**
 * Implements hook_block_view().
 */
function geographic_region_block_view($delta = '') {
  $block = [];
  switch ($delta) {
    case 'region_page_title':
      return geographic_region_region_page_title_block_view();
      break;

    case 'region_switch_topic':
      return geographic_region_region_switch_topic_block_view();
      break;

    case 'region_downloadable_documents':
      return geographic_region_region_downloadable_documents_block_view();
      break;
  }
  return $block;
}

/**
 * Implements hook_taxonomy_term_view().
 */
function geographic_region_taxonomy_term_view($term, $view_mode, $langcode) {
  if ($view_mode == 'full') {
    $vocabulary = taxonomy_vocabulary_machine_name_load('geographical_region');
    if ($term->vid == $vocabulary->vid) {
      // Redirect the default term page to region panel page.
      drupal_goto('regions/' . strtolower(str_replace(' ', '-', $term->name_original)));
    }
  }
}

/**
 * Implements hook_views_pre_render().
 */
function geographic_region_views_pre_render(&$view) {
  if ($view->name == 'regional_treaties' && $view->current_display == 'block_1') {
    if (!empty($view->result)) {
      foreach ($view->result as &$result) {
        $title = !empty($result->field_title_field[0]['raw'])
          ? $result->field_title_field[0]['raw']
          : '';
        $official_name = !empty($result->field_field_official_name[0]['raw'])
          ? $result->field_field_official_name[0]['raw']
          : '';
        if ((empty($official_name) && !empty($title)) || ($official_name == $title)) {
          $result->field_field_official_name = $result->field_title_field;
          $result->field_title_field = [];
        }
      }
    }
  }
}
