<?php
/**
 * @file
 * Code for the treaty feature.
 */

include_once 'treaty.features.inc';

/**
 * Defines menu items and page callbacks.
 *
 * @return
 *   An associative array of properties for each path.
 */
function treaty_menu() {
  $items['treaties'] = array(
    'title' => t('Treaties'),
    'page callback' => 'treaty_view',
    'access arguments' => array('access content')
  );

  return $items;
}

/**
 * Registers module's theme implementations.
 *
 * @return
 *   An associative array of theme hook information.
 */
function treaty_theme() {
  return array(
    'treaties' => array(
      'variables' => array(
        'regions' => NULL,
        'treaties' => NULL
      )
    )
  );
}

function _treaty_get_regions() {
  global $language;

  $query = new EntityFieldQuery();

  $query->entityCondition('entity_type', 'taxonomy_term')
    ->entityCondition('bundle', 'geographical_region')
    ->propertyOrderBy('weight');

  $result = $query->execute();
  $tids = array_keys($result['taxonomy_term']);
  $terms = entity_load('taxonomy_term', $tids);
  $regions = array();

  foreach ($terms as $term) {
    $regions[] = (object) array(
      'tid' => $term->tid,
      'name' => $term->name_field[$language->language][0]['safe_value']
    );
  }

  return $regions;
}

function _treaty_get_treaties() {
  global $language;

  $query = new EntityFieldQuery();

  $query->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', 'treaty')
    ->propertyCondition('status', NODE_PUBLISHED);

  $result = $query->execute();
  $nids = array_keys($result['node']);
  $nodes = entity_load('node', $nids);
  $treaties = array();

  foreach ($nodes as $node) {
    $treaty = array();

    $treaty['title'] = $node->title_field[$language->language][0]['safe_value'];
    $treaty['official_name'] = $node->field_official_name[LANGUAGE_NONE][0]['safe_value'];
    $treaty['regions'] = array();

    if (!empty($node->field_treaty_year)) {
      $date = date_create($node->field_treaty_year[LANGUAGE_NONE][0]['value']);
      $treaty['year'] = date_format($date, 'Y');
    }

    $treaty['topics'] = NULL;

    if (!empty($node->field_logo)) {
      $treaty['logo'] = $node->field_logo[LANGUAGE_NONE][0]['uri'];
    }

    $treaties[] = (object) $treaty;
  }

  return $treaties;
}

/**
 * Displays the treaties page when the user visits the path.
 *
 * @return
 *   String representing the content of the page.
 */
function treaty_view() {
  return theme('treaties', array(
    'regions' => _treaty_get_regions(),
    'treaties' => _treaty_get_treaties()
  ));
}
