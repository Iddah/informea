<?php
/**
 * @file
 * Code for the informea_search feature.
 */

include_once 'informea_search.features.inc';

/**
 * Implements hook_views_pre_render().
 */
function informea_search_views_pre_render(&$view) {
  if ($view->name == 'informea_search') {
    module_load_include('inc', 'informea_search', 'informea_search.results');
    $group = new InforMEASearchResultsGrouping();
    $view->result = $group->getResults($view->result);
  }
}

/**
 * Implements hook_form_alter().
 */
function informea_search_form_search_form_alter(&$form, &$form_state) {
  $form['#method'] = 'post';
  $form['#action'] = url('search');
  $form['#submit'] = array('informea_search_form_search_form_submit');
}

function informea_search_form_search_form_submit($form, $form_state) {
  $input = $form_state['values']['keys'];
  drupal_goto('search/' . $input);
}


function informea_search_facet_items_alter(&$build, &$settings) {
  unset($build['treaty_paragraph']);
  unset($build['treaty_article']);
  unset($build['treaty']);
  unset($build['decision_paragraph']);
  // unset($build['event_calendar']);
}

function informea_search_search_api_solr_query_alter(array &$call_args, SearchApiQueryInterface $query) {
  foreach($call_args['params']['fq'] as $k => &$fq) {
    if ($fq == '{!tag=facet:type}ss_type:"decision"') {
      $fq = '{!tag=facet:type}ss_type:("decision" OR "decision_paragraph")';
    }
    if ($fq == '{!tag=facet:type}ss_type:"treaty"') {
      $fq = '{!tag=facet:type}ss_type:("treaty" OR "treaty_article" OR "treaty_paragraph")';
    }
  }
}

/**
* Implementation of hook_menu().
*/
function informea_search_menu() {
  $items['ajax/search/%'] = array(
    'page callback' => 'informea_search_ajax_get_ajax',
    'page arguments' => array(2),
    'type' => MENU_CALLBACK,
    'access arguments' => array('access content'),
    'delivery callback' => 'informea_search_ajax_callback',
  );

  return $items;
}

function informea_search_ajax_get_ajax_treaties($term, &$data) {
  $condition = db_or()
    ->condition('n.title', '%' . $term . '%', 'like')
    ->condition('fa.field_title_abbreviation_value', '%' . $term . '%', 'like')
    ->condition('fn.field_official_name_value', '%' . $term . '%', 'like');

  $query = db_select('node', 'n')
    ->condition('n.type', 'treaty')
    ->condition('n.status', NODE_PUBLISHED)
    ->fields('n', array('nid'));

  $query->leftJoin('field_data_field_title_abbreviation', 'fa', 'fa.entity_id = n.nid');
  $query->leftJoin('field_data_field_official_name', 'fn', 'fn.entity_id = n.nid');

  $query->condition($condition)
    ->range(0, 5);

  $result = $query->execute()->fetchAllKeyed();

  if (!empty($result)) {
    $nids = array_keys($result);
    $nodes = entity_load('node', $nids);

    foreach ($nodes as $node) {
      $wrapper = entity_metadata_wrapper('node', $node);

      $img = treaty_url_logo($node);

      $data[] = array(
        'category' => t('Treaties'),
        'label' => $img . ' ' . $wrapper->label(),
        'link' => url('node/' . $wrapper->getIdentifier()),
        'value' => $wrapper->label()
      );
    }
  }
}

function informea_search_ajax_get_ajax_countries($term, &$data) {
  $query = new EntityFieldQuery();

  $query->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', 'country')
    ->propertyCondition('status', NODE_PUBLISHED)
    ->fieldCondition('title_field', 'value', '%' . $term . '%', 'like')
    ->range(0, 5);

  $result = $query->execute();

  if (isset($result['node'])) {
    $nids = array_keys($result['node']);
    $nodes = entity_load('node', $nids);

    foreach ($nodes as $node) {
      $wrapper = entity_metadata_wrapper('node', $node);

      $iso2 = strtolower($wrapper->field_country_iso2->value());
      $img = theme('image', array('path' => drupal_get_path('theme', 'informea_theme') . '/img/flags/flag-' . $iso2 . '.png'));

      $data[] = array(
        'category' => t('Countries'),
        'label' => $img . ' ' . $wrapper->label(),
        'link' => url('countries/' . $iso2),
        'value' => $wrapper->label()
      );
    }
  }
}

function informea_search_ajax_get_ajax_terms($term, &$data) {
  $query = new EntityFieldQuery();

  $query->entityCondition('entity_type', 'taxonomy_term')
    ->entityCondition('bundle', 'thesaurus_informea')
    ->fieldCondition('name_field', 'value', '%' . $term . '%', 'like')
    ->range(0, 5);

  $result = $query->execute();

  if (isset($result['taxonomy_term'])) {
    $tids = array_keys($result['taxonomy_term']);
    $terms = entity_load('taxonomy_term', $tids);

    foreach ($terms as $term) {
      $wrapper = entity_metadata_wrapper('taxonomy_term', $term);

      $data[] = array(
        'category' => t('Terms'),
        'label' => $wrapper->label(),
        'link' => url('terms/' . $wrapper->getIdentifier()),
        'value' => $wrapper->label()
      );
    }
  }
}

function informea_search_ajax_get_ajax($term) {
  $data = array(
    array(
      'category' => '',
      'label' => t('Search for: <strong>@term</strong>', array('@term' => $term)),
      'link' => url('search/' . $term),
      'value' => $term
    )
  );

  informea_search_ajax_get_ajax_treaties($term, $data);
  informea_search_ajax_get_ajax_countries($term, $data);
  informea_search_ajax_get_ajax_terms($term, $data);

  return $data;
}

function informea_search_ajax_callback($data) {
  $source = json_encode($data);

  header('Content-Type: application/json');

  print $source;
}
