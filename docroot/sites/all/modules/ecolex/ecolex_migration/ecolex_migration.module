<?php

/**
 * Implements hook_migrate_api().
 *
 * Set the API level to 2, for migration classes to be recognized by Migrate.
 */
function ecolex_migration_migrate_api() {
  module_load_include('inc', 'elis_consumer', 'includes/migrations/TreatyElisMigration');
  module_load_include('inc', 'elis_consumer', 'includes/migrations/CourtDecisionElisMigration');

  $ret = array(
    'api' => 2,
    'groups' => array(
      'ecolex' => array(
        'title' => 'ECOLEX content migration'
      ),
      'elis' => array(
        'title' => t('ELIS direct data migration'),
      ),
    ),
    'migrations' => array(),
  );
  $ret['migrations']['elis_treaties'] = array(
    'class_name' => 'ElisTreatyMigration',
    'group_name' => 'elis',
    'source_url_pattern' => 'http://www.ecolex.org/elis_isis3w.php?database=tre&search_type=page_search&table=all&format_name=@xmlexp&lang=xmlf&page_header=@xmlh&spage_query=SPAGE_QUERY_VALUE&spage_first=SPAGE_FIRST_VALUE',
    'xml_encoding' => 'iso-8859-15',
  );
  $ret['migrations']['elis_court_decisions'] = array(
    'class_name' => 'ElisCourtDecisionMigration',
    'group_name' => 'elis',
    'source_url_pattern' => 'http://www.ecolex.org/elis_isis3w.php?database=cou&search_type=view_query_search&table=all&format_name=@xmlexp&lang=xmlf&page_header=@xmlh&vq_query=ID:"RECORD_ID"',
    'xml_encoding' => 'iso-8859-15',
  );
  // source_url_pattern also dublicated in EcolexLegislationMigrateSource because of cache
  $ret['migrations']['ecolex_legislation'] = array(
    'class_name' => 'EcolexLegislationMigration',
    'group_name' => 'ecolex',
    'source_url_pattern' => 'http://www.ecolex.org/export/?type=legislation&format=json',
  );
  $ret['migrations']['ecolex_literature'] = array(
    'class_name' => 'EcolexLiteratureMigration',
    'group_name' => 'ecolex',
    'source_url_pattern' => 'http://www.ecolex.org/export/?type=literature&format=json',
  );
  $ret['migrations']['ecolex_treaty'] = array(
    'class_name' => 'EcolexTreatyMigration',
    'group_name' => 'ecolex',
    'source_url_pattern' => 'http://www.ecolex.org/export/?type=treaty&format=json',
  );
  return $ret;
}

/**
 * Implements hook_cronapi().
 *
 * Provided by the elysia_cron module.
 */
function ecolex_migration_cronapi($ob, $job = NULL) {
  return array(
    'ecolex_migration_literature_sync' => array(
      'description' => 'Update Ecolex literatures',
      'rule' => '0 1 * * *', // Every day at 01:00
    ),
    'ecolex_migration_legislation_sync' => array(
      'description' => 'Update Ecolex legislations',
      'rule' => '0 1 * * *', // Every day at 01:00
    ),
    'ecolex_migration_treaty_sync' => array(
      'description' => 'Update Ecolex treaties',
      'rule' => '0 1 * * *', // Every day at 01:00
    ),
  );
}

function ecolex_migration_process_import($migration_name) {
  /* @var $migration EcolexLegislationMigration */
  $migration = Migration::getInstance($migration_name);

  if ($migration->getStatus() != MigrationBase::STATUS_IDLE) {
    watchdog('ecolex_migration', '@migration migration is currently not idle, skipping (status: @status)',
      array(
        '@migration' => $machine_name,
        '@status' => $migration->getStatus()
      ),
      WATCHDOG_ERROR
    );
  }
  else {
    watchdog('ecolex_migration', '@migration migration: starting import',
      array('@migration' => $migration_name), WATCHDOG_INFO);

    $result = $migration->processImport();

    watchdog('ecolex_migration', '@migration migration: finished with result: @result',
      array('@migration' => $migration_name, '@result' => $result), WATCHDOG_INFO);
  }
}

function ecolex_migration_literature_sync() {
  ecolex_migration_process_import('ecolex_literature');
}

function ecolex_migration_legislation_sync() {
  ecolex_migration_process_import('ecolex_legislation');
}

function ecolex_migration_treaty_sync() {
  ecolex_migration_process_import('ecolex_treaty');
}
